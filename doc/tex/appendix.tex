
\section{SHA3 Instruction Discussions}
\label{sec:appendix:sha3}

The SHA3 secure hash function \cite{nist:fips:202} is based on
the KECCAK-P family of permutations.
SHA3 is notably slower than SHA2 when implemented in software.
It also has a large state size (1600 bits) which is very irregularly
accessed, making it difficult to accelerate
the core {\em compute} operations as part of a scalar CPU pipeline.
We distinguish between {\em compute} operations (which modify the
round function state) and {\em address} operations (which calculate
indexes into the round function state) when motivating these instructions.

The core operations of the KECCAK-P round function are rotations
and XORs, which are already well supported by the RISC-V
base and Bitmanip architectures.
The round function state is accessed as a $5*5$ array of
64-bit words.
See Figure \ref{fig:listing:sha3} for a C code implementation of
the core KeccakP1600 round function which SHA3 depends on.
When developing lightweight accelerator instructions for SHA3, we
consider two broad implementation options:

\begin{itemize}
\item Loop unrolled: Here, all of the loops of the round function are
    unrolled, meaning that all variations of the \lstinline{index}
    function are computed at compile time, and are emitted as immediate
    offsets to load and store instructions.
    In this case, there is little that can be added to a scalar
    pipeline to accelerate SHA3, other than the bitwise rotation instructions
    (for RV64) or funnel shift instructions (for RV32).
\item Loop rolled-up: The loops are not unrolled, and the
    \lstinline{index} functions are re-computed on every loop iteration.
    This means that {\em either} {\tt rem} instructions are used to
    compute the modulo $5$ operations, or they can be replaced with a
    lookup table.
    In both cases, the extra number of instructions executed is
    substantial.
\end{itemize}


\begin{figure}
\lstinputlisting[language=c]{../benchmarks/hash/sha3/keccakp1600.c}
\caption{A C code implementation of the KeccakP1600 permutation, as
used by the SHA3 secure hash function.}
\label{fig:listing:sha3}
\end{figure}

